<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EMS ‚Üí ELECTION-MONITORING-SYSTEM: EVERY PERSON IS LEGACY IN OUR COUNTRY</title>

<!-- Lucide Icons (Modern Feather) -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
/* ------------------------------ */

:root{
  --radius:16px;
  --transition:260ms cubic-bezier(.25,.9,.25,1);
  --font-main: "Inter", system-ui, -apple-system, "Segoe UI", Roboto;
  --font-lux: "Cormorant Garamond", serif;

  /* LUXURY ACCENTS */
  --royal-gold:#d5b27c;
  --royal-gold-soft:#e6cfa5;
  --royal-gold-glow:0 0 22px rgba(214,178,124,0.45);
  --royal-silver:#cfd3d8;

  /* NEON ACCENTS (subtle) */
  --accent1:#87e6ff;
  --accent2:#9affc9;

  /* LIGHT MODE */
  --page-bg: linear-gradient(180deg,#f8f9fb,#edf2f7);
  --text-primary:#0e1013;
  --text-muted:#666e78;
  --card-bg:rgba(255,255,255,0.75);
  --glass-border:rgba(0,0,0,0.12);
  --input-bg:rgba(0,0,0,0.07);
  --shadow-card:0 14px 34px rgba(0,0,0,0.15);
}

:root.dark{
  /* ROYAL ROLLS ROYCE DARK BACKGROUND */
  --page-bg:
    radial-gradient(900px 400px at 8% 8%, rgba(214,178,124,0.10), transparent),
    radial-gradient(900px 400px at 95% 95%, rgba(135,230,255,0.08), transparent),
    #070809; /* Onyx Black */

  --text-primary:#f5f6f7;
  --text-muted:#9fa5ac;
  --card-bg:rgba(14,16,20,0.55);
  --glass-border:rgba(255,255,255,0.10);
  --input-bg:rgba(255,255,255,0.06);
  --shadow-card:0 14px 34px rgba(214,178,124,0.1);
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:var(--font-main);
  background:var(--page-bg);
  color:var(--text-primary);
  transition:var(--transition);
}

/* ------------------------------
   LUXURY ORB BACKGROUND
------------------------------ */
.bg-orb{
  position:fixed;
  width:420px;height:420px;
  border-radius:50%;
  filter:blur(160px);
  opacity:0.22;
  z-index:-2;
}
#orb1{background:var(--royal-gold);top:-120px;left:-80px;}
#orb2{background:var(--accent1);bottom:-120px;right:-80px;}

/* ------------------------------
   HEADER
------------------------------ */
header{
  position:sticky;top:0;z-index:99;
  backdrop-filter:blur(14px);
  background:rgba(0,0,0,0.12);
  border-bottom:1px solid var(--glass-border);
  padding:16px 28px;
  display:flex;justify-content:space-between;align-items:center;
}

/* brand + logo container */
.brand-center{
  display:flex;align-items:center;gap:12px;
}
.brand-left{
  display:flex;align-items:center;gap:12px;
}
.brand-title{
  font-family:var(--font-lux);
  font-size:28px;font-weight:700;
  letter-spacing:.5px;
  color:var(--royal-gold);
}
.brand-sub{font-size:13px;color:var(--text-muted)}

/* NAV */
nav.top-nav{display:flex;align-items:center;gap:16px}
.nav-links{display:flex;gap:10px;list-style:none;}
.nav-links a{
  text-decoration:none;
  padding:10px 16px;
  font-weight:700;
  border-radius:10px;
  color:var(--text-muted);
  transition:var(--transition);
}
.nav-links a:hover{
  transform:translateY(-2px);
  color:var(--royal-gold);
}
.nav-links a.active{
  background:linear-gradient(90deg,#111,#1b1d20);
  border:1px solid var(--royal-gold-soft);
  color:var(--royal-gold);
  box-shadow:var(--royal-gold-glow);
}

/* BUTTON */
.btn{
  padding:12px 18px;
  border-radius:12px;
  background:linear-gradient(135deg,#111,#222);
  border:1px solid var(--royal-gold-soft);
  color:var(--royal-gold);
  font-weight:800;
  cursor:pointer;
  transition:var(--transition);
}
.btn:hover{
  transform:scale(1.05);
  box-shadow:var(--royal-gold-glow);
}
/* Fix dropdown visibility inside dark theme */
.input select {
  background: var(--card-bg);
  color: var(--text-primary);
  font-weight: 700;
  border-radius: 12px;
  padding: 12px;
  appearance: none;
}

/* Style options so they are visible */
.input select option {
  background: #111; /* dark background for popup list */
  color: var(--royal-gold-soft); /* golden text */
  font-weight: 700;
  padding: 10px;
  border: none;
}

/* Light theme fallback */
:root:not(.dark) .input select option {
  background: #fff;
  color: #222;
}

/* CARDS */
.card{
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  padding:26px;
  border-radius:18px;
  backdrop-filter:blur(22px);
  box-shadow:var(--shadow-card);
  animation:fadeIn .45s ease;
}

/* ROLE CARDS */
.role-card{
  display:flex;align-items:center;gap:20px;
  padding:26px;border-radius:18px;
  background:var(--card-bg);
  border:1px solid var(--glass-border);
  cursor:pointer;transition:var(--transition);
}
.role-card:hover{
  transform:translateY(-6px);
  box-shadow:var(--royal-gold-glow);
  border-color:var(--royal-gold-soft);
}
.icon-box{
  width:80px;height:80px;border-radius:18px;
  display:grid;place-items:center;
  background:linear-gradient(135deg,#0b0c0d,#1b1d20);
  border:1px solid var(--royal-gold-soft);
  font-size:34px;
  color:var(--royal-gold);
  box-shadow:var(--royal-gold-glow);
}

/* INPUTS */
.input{
  background:var(--input-bg);
  padding:16px;border-radius:14px;
}
.input input, .input select, textarea{
  width:100%;background:transparent;border:none;
  color:var(--text-primary);font-weight:700;outline:none;
  font-size:15px;
}

/* HERO IMAGE */
.hero-image img{
  width:430px;border-radius:20px;
  filter:drop-shadow(0 0 30px rgba(0,0,0,0.45));
}

/* POPUP */
.overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.55);
  display:grid;place-items:center;
  opacity:0;visibility:hidden;
  transition:var(--transition);
}
.overlay.show{opacity:1;visibility:visible}
.popup{
  background:var(--card-bg);
  padding:24px;border-radius:16px;
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow-card);
}

/* Fade animation */
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}

@keyframes blink{
  0%, 100%{opacity:1}
  50%{opacity:0.4}
}

section{display:none;}
section.active{display:block;}
/* small admin table styles */
.admin-table{width:100%;border-collapse:collapse;margin-top:10px}
.admin-table th,.admin-table td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:left;color:var(--text-primary);font-size:13px}
.admin-table thead th{font-weight:800;color:var(--royal-gold)}

/* solved status styling */
.status-solved{color:#8BC34A;font-weight:800}
.status-pending{color:var(--text-muted);font-weight:700}

/* thumbnail */
.issue-thumb{width:80px;height:auto;border-radius:8px;object-fit:cover;cursor:pointer;border:1px solid rgba(0,0,0,0.08)}
/* small caption under preview */
#photoPreview img{max-width:120px;border-radius:8px;margin-top:8px;display:block}
.observer-thumb{width:100px;height:70px;object-fit:cover;border-radius:8px;margin-right:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer}
.observer-report{display:flex;gap:12px;align-items:flex-start;border-bottom:1px solid rgba(255,255,255,0.04);padding:10px 0}
.observer-meta{font-size:13px;color:var(--text-muted)}
.admin-section-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
.small-muted{color:var(--text-muted);font-size:13px}
</style>
</head>

<body>
<!-- BG ORBS -->
<div id="orb1" class="bg-orb"></div>
<div id="orb2" class="bg-orb"></div>

<header>
  <!-- logo + brand -->
  <div class="brand-center">
    <div class="brand-left" aria-hidden="false" style="align-items:center;">
      <!-- Election logo SVG (keeps royal-gold style) -->
      <svg width="40" height="40" viewBox="0 0 24 24" style="margin-right:8px;flex-shrink:0" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
        <g fill="none" fill-rule="evenodd">
          <circle cx="12" cy="12" r="11" fill="none" stroke="rgba(214,178,124,0.18)" stroke-width="1"/>
          <path d="M7 9h10v2H7zM7 13h10v2H7z" fill="#d5b27c"/>
          <rect x="4" y="6" width="16" height="12" rx="2" stroke="none" fill="rgba(213,178,124,0.03)"/>
        </g>
      </svg>

      <div>
        <div class="brand-title">EMS</div>
        <div class="brand-sub">Election Monitoring System</div>
      </div>
    </div>
  </div>

  <nav class="top-nav" aria-label="Main navigation">
    <ul class="nav-links" role="menubar">
      <li><a class="active" data-target="home" onclick="safeNav(event,'home')" role="menuitem">Home</a></li>
      <li><a data-target="citizen" onclick="safeNav(event,'citizen')" role="menuitem">Citizen</a></li>
      <li><a data-target="admin" onclick="safeNav(event,'admin')" role="menuitem">Admin</a></li>
      <li><a data-target="analyst" onclick="safeNav(event,'analyst')" role="menuitem">Analyst</a></li>
      <li><a data-target="observer" onclick="safeNav(event,'observer')" role="menuitem">Observer</a></li>
    </ul>

    <button class="btn" onclick="toggleTheme()" title="Toggle Theme" aria-pressed="false">
      <i data-lucide="sun"></i>
    </button>

    <!-- Logout button on right -->
    <button class="btn" id="logoutBtn" onclick="logout()" title="Logout" style="display:none;margin-left:8px">
      Logout
    </button>
  </nav>
</header>

<main style="max-width:1100px;margin:30px auto;padding:0 20px">

  <!-- LOGIN -->
  <section id="login" class="active">
    <div class="card" style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
      <div style="flex:1;min-width:260px">
        <h2 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:30px;font-weight:700">
          Welcome to EMS
        </h2>
        <p id="login-desc" style="color:var(--text-muted)">Login with your Voter ID & Indian phone number. Select your role.</p>

        <form id="loginForm" onsubmit="return handleLogin(event)" autocomplete="off">
          <!-- Voter ID -->
          <div class="input" title="Voter ID format: 3 uppercase letters then 7 digits (e.g. APZ1234567)">
            <input id="voterId" type="text" placeholder="Voter ID (e.g. APZ1234567)" maxlength="10" required aria-label="Voter ID">
          </div>

          <!-- Phone -->
          <div class="input" style="margin-top:14px">
            <input id="phone" type="tel" placeholder="Phone (10 digits)" required aria-label="Phone">
          </div>

          <!-- Role dropdown -->
          <div class="input" style="margin-top:14px">
            <select id="roleSelect" required aria-label="Select your role">
              <option value="">Select Your Role</option>
              <option value="admin">Admin</option>
              <option value="citizen">Citizen</option>
              <option value="analyst">Analyst</option>
              <option value="observer">Observer</option>
            </select>
          </div>

          <div style="display:flex;gap:14px;margin-top:16px">
            <button class="btn" type="submit">Login / Register</button>
            <button class="btn" style="background:#444;color:var(--royal-gold-soft)" type="button" onclick="guestAttempt()">Guest</button>
          </div>
        </form>
      </div>

      <div class="hero-image" aria-hidden="true">
        <img src="https://images.unsplash.com/photo-1529107386315-e1a2ed48a620?q=80&w=900" alt="Voting Illustration">
      </div>
    </div>
  </section>

  <!-- HOME -->
  <section id="home">
    <h1 style="font-size:30px;font-family:var(--font-lux);font-weight:700;color:var(--royal-gold)">
      Make Elections Safer ¬∑ Make Voices Count
    </h1>
    <p style="color:var(--text-muted)">Select your role:</p>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:22px;margin-top:20px">

      <div class="role-card" onclick="safeNavClick('citizen')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="shield-check"></i></div>
        <div><h3>Citizen</h3><p style="color:var(--text-muted)">Report issues securely</p></div>
      </div>

      <div class="role-card" onclick="safeNavClick('admin')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="settings"></i></div>
        <div><h3>Admin</h3><p style="color:var(--text-muted)">Platform management</p></div>
      </div>

      <div class="role-card" onclick="safeNavClick('observer')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="eye"></i></div>
        <div><h3>Observer</h3><p style="color:var(--text-muted)">Live booth monitoring</p></div>
      </div>

      <div class="role-card" onclick="safeNavClick('analyst')" role="button" tabindex="0">
        <div class="icon-box"><i data-lucide="bar-chart-3"></i></div>
        <div><h3>Analyst</h3><p style="color:var(--text-muted)">Charts & insights</p></div>
      </div>

    </div>
  </section>

  <!-- CITIZEN -->
  <section id="citizen">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold)">Citizen Portal</h2>
      <p style="color:var(--text-muted)">Describe an election issue:</p>
      <textarea id="issueText" style="width:100%;height:150px;margin-top:14px;border-radius:12px;background:var(--input-bg);color:var(--text-primary);padding:14px;border:none;outline:none"></textarea>

      <!-- Photo upload option -->
      <div class="input" style="margin-top:14px">
        <label for="issuePhoto" style="font-weight:800;color:var(--text-muted);display:block;margin-bottom:8px">Attach Photo (optional)</label>
        <input id="issuePhoto" type="file" accept="image/*" aria-label="Attach photo" />
        <div id="photoPreview" aria-hidden="true"></div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Max file size: 3MB. JPG/PNG preferred.</div>
      </div>

      <button class="btn" style="margin-top:14px" onclick="submitIssue()">Submit Issue</button>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="admin">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold)">Admin Panel ‚Äî All Data Overview</h2>

      <div style="display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px">

        <div class="card">
          <div class="admin-section-controls">
            <strong style="flex:1">Citizen Issues</strong>
            <button class="btn" onclick="renderAdminCitizenIssues()">Refresh</button>
            <button class="btn" onclick="downloadJSON('citizen-issues', loadIssuesFromStorage())">Export JSON</button>
          </div>
          <table class="admin-table" id="adminCitizenTable" aria-live="polite">
            <thead>
              <tr><th>Time</th><th>User</th><th>Issue</th><th>Photo</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card">
          <div class="admin-section-controls">
            <strong style="flex:1">Observer Reports</strong>
            <button class="btn" onclick="renderAdminObserverReports()">Refresh</button>
            <button class="btn" onclick="downloadJSON('observer-reports', loadObserverReports())">Export JSON</button>
          </div>
          <table class="admin-table" id="adminObserverTable" aria-live="polite">
            <thead>
              <tr><th>Time</th><th>Observer</th><th>Area</th><th>Problem</th><th>Photos</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card">
          <div class="admin-section-controls">
            <strong style="flex:1">Analyst Reports</strong>
            <button class="btn" onclick="renderAdminAnalystReports()">Refresh</button>
            <button class="btn" onclick="downloadJSON('analyst-reports', loadAnalystReports())">Export JSON</button>
          </div>
          <table class="admin-table" id="adminAnalystTable" aria-live="polite">
            <thead>
              <tr><th>Time</th><th>Analyst</th><th>Notes</th><th>Summary</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </section>

  <!-- OBSERVER -->
  <section id="observer">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold);font-size:28px;margin-bottom:10px">Observer ‚Äî Report Voting Area Issues</h2>

      <div style="display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start">
        <!-- form -->
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:20px">Submit Observer Report</h3>

          <div class="input" style="margin-top:12px">
            <label for="obsArea" style="font-weight:800;color:var(--text-muted);display:block;margin-bottom:6px">Voting Area / Booth</label>
            <input id="obsArea" type="text" placeholder="e.g. Booth #2034, District A" aria-label="Voting area">
          </div>

          <div class="input" style="margin-top:12px">
            <label for="obsProblem" style="font-weight:800;color:var(--text-muted);display:block;margin-bottom:6px">Problem Observed</label>
            <textarea id="obsProblem" placeholder="Describe the problem (e.g. long queues, missing staff, machine error)" style="width:100%;height:120px;background:transparent;border:none;outline:none"></textarea>
          </div>

          <div class="input" style="margin-top:12px">
            <label for="obsPhotos" style="font-weight:800;color:var(--text-muted);display:block;margin-bottom:6px">Attach Photos (evidence) ‚Äî up to 3</label>
            <input id="obsPhotos" type="file" accept="image/*" multiple aria-label="Attach photos" />
            <div id="obsPhotoPreview" style="display:flex;margin-top:8px;flex-wrap:wrap;gap:8px" aria-hidden="true"></div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Each image max 3MB. JPG/PNG preferred.</div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px">
            <button class="btn" onclick="submitObserverReport()">Submit Report</button>
            <button class="btn" style="background:#444;color:var(--royal-gold-soft)" type="button" onclick="clearObserverForm()">Clear</button>
          </div>
        </div>

        <!-- live stats & list -->
        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="card">
            <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:18px">Quick Live Stats</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
              <div style="background:transparent;padding:10px;border-radius:8px"><strong>Total Reports</strong><div id="obsTotal" style="font-weight:800;color:var(--royal-gold-soft);margin-top:6px">0</div></div>
              <div style="background:transparent;padding:10px;border-radius:8px"><strong>Pending</strong><div id="obsPending" style="font-weight:800;color:var(--royal-gold-soft);margin-top:6px">0</div></div>
            </div>
          </div>

          <div class="card" style="overflow:auto;max-height:360px">
            <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:18px">Your Recent Observer Reports</h3>
            <div id="observerReportsList" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <!-- existing LIVE feed below (kept from original) -->
      <div style="margin-top:18px">
        <h2 style="font-family:var(--font-lux);color:var(--royal-gold);font-size:22px;margin-bottom:8px">üìä EMS Live Election Monitor</h2>
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
          <span style="background:#dc143c;color:#fff;padding:8px 16px;border-radius:12px;font-weight:800;animation:blink 1s infinite">‚óè LIVE</span>
          <span style="color:var(--text-muted);font-size:13px">Real-time election monitoring</span>
        </div>

        <!-- LIVE STAT CARDS -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-top:12px">
          <div class="card">
            <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Total Reports</h3>
            <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="reports">12,485</div>
          </div>

          <div class="card">
            <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Verified Booths</h3>
            <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="booths">4,892</div>
          </div>

          <div class="card">
            <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Security Alerts</h3>
            <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="alerts">47</div>
          </div>

          <div class="card">
            <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:22px">Voter Turnout (%)</h3>
            <div style="font-size:40px;font-weight:800;color:var(--royal-gold-soft);margin-top:10px" id="turnout">68%</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ANALYST -->
  <section id="analyst">
    <div class="card">
      <h2 style="font-family:var(--font-lux);color:var(--royal-gold)">Analytics Dashboard</h2>

      <div style="display:grid;grid-template-columns:1fr 360px;gap:20px;margin-top:12px">
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:20px">Run Analysis</h3>
          <div class="input" style="margin-top:10px">
            <label for="analysisNotes" style="font-weight:800;color:var(--text-muted);display:block;margin-bottom:6px">Notes / Observations</label>
            <textarea id="analysisNotes" placeholder="Write quick observations or context..." style="width:100%;height:120px;background:transparent;border:none;outline:none"></textarea>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn" onclick="runAnalysis()">Analyze & Save</button>
            <button class="btn" style="background:#444;color:var(--royal-gold-soft)" onclick="renderAnalystCharts()">Refresh Charts</button>
          </div>

          <div style="margin-top:12px" class="small-muted">Analysis is derived from citizen reports and observer reports stored in the system. Analyst may add notes and save.</div>
        </div>

        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:20px">Recent Analyses</h3>
          <div id="analystReportsList" style="margin-top:10px;max-height:220px;overflow:auto"></div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:20px;margin-top:20px">
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:18px">Voting Trend</h3>
          <div id="lineChart" style="height:260px;margin-top:10px"></div>
        </div>
        <div class="card">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:18px">Reports by Category</h3>
          <div id="barChart" style="height:260px;margin-top:10px"></div>
        </div>
        <div class="card" style="grid-column:1/-1">
          <h3 style="color:var(--royal-gold);font-family:var(--font-lux);font-size:18px">Issue Breakdown</h3>
          <div id="pieChart" style="height:320px;margin-top:10px"></div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- POPUP -->
<div class="overlay" id="overlay" aria-hidden="true"><div class="popup" id="popup"></div></div>

<script>
/* ------------------------------
   Core DOM refs & init
------------------------------ */
const overlay = document.getElementById('overlay');
const popup = document.getElementById('popup');
lucide.createIcons();

let lineChartObj = null;
let barChartObj = null;
let pieChartObj = null;

/* ------------------------------
   Popup helper (reused everywhere)
------------------------------ */
function showPopup(title, sub){
  if(popup){
    popup.innerHTML = `<strong>${escapeHtml(title)}</strong><p style="color:var(--text-muted);margin-top:6px">${escapeHtml(sub)}</p>`;
  }
  if(overlay){
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    setTimeout(()=>{
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    },1500);
  }
}

/* show image in popup (uses DOM methods to avoid injecting untrusted HTML) */
function showImagePopup(title, imageDataUrl){
  if(!popup) return;
  popup.innerHTML = '';
  const h = document.createElement('strong');
  h.textContent = title || 'Photo';
  const br = document.createElement('div');
  br.style.marginTop = '8px';
  const img = document.createElement('img');
  img.src = imageDataUrl;
  img.style.maxWidth = '520px';
  img.style.maxHeight = '70vh';
  img.style.borderRadius = '8px';
  img.alt = 'Photo';
  popup.appendChild(h);
  popup.appendChild(br);
  popup.appendChild(img);

  if(overlay){
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
    setTimeout(()=>{
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    },4000);
  }
}

/* small escape util to avoid injecting raw HTML from user strings */
function escapeHtml(str){
  if(!str && str !== 0) return '';
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

/* ------------------------------
   Auth helpers
------------------------------ */
function isLoggedIn(){ return localStorage.getItem("ems-logged")==="true"; }
function setLogged(x, voterId, role){
  if(x){
    localStorage.setItem("ems-logged","true");
    localStorage.setItem("ems-user", voterId);      // store voter id as user
    localStorage.setItem("ems-role", role);         // store role
  }else{
    localStorage.removeItem("ems-logged");
    localStorage.removeItem("ems-user");
    localStorage.removeItem("ems-role");
  }
}
function getRole(){ return (localStorage.getItem("ems-role")||'').toLowerCase(); }
function getUser(){ return localStorage.getItem("ems-user") || 'Unknown'; }

/* logout helper */
function logout(){
  setLogged(false);
  document.getElementById('logoutBtn').style.display = 'none';
  showPopup('Logged out','You have been logged out.');
  setTimeout(()=> showSection('login'), 600);
}

/* ------------------------------
   Navigation + role-based access
------------------------------ */
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  const el = document.getElementById(id);
  if(el) el.classList.add("active");

  document.querySelectorAll(".nav-links a").forEach(a=>a.classList.remove("active"));
  const nav = document.querySelector(`.nav-links a[data-target="${id}"]`);
  if(nav) nav.classList.add("active");
}

/* safeNav used by nav links (with event) */
function safeNav(e,id){
  if(e && e.preventDefault) e.preventDefault();
  const role = getRole();
  if(!isLoggedIn()){ showPopup("Please login","Access restricted."); showSection("login"); return; }

  if(canAccessRole(role, id)){
    showSection(id);
    // when admin opens admin section, ensure admin views are refreshed
    if(id === 'admin') renderAdminAllData();
    if(id === 'analyst') renderAnalystCharts();
    if(id === 'observer') renderObserverReports();
  }else{
    showPopup("Access Denied", `You cannot access the ${capitalize(id)} role.`);
    // Stay in current section (do not navigate)
  }
}

/* safeNavClick used by role cards (no event) */
function safeNavClick(id){
  const role = getRole();
  if(!isLoggedIn()){ showPopup("Please login","Access restricted."); showSection("login"); return; }
  if(canAccessRole(role, id)){
    showSection(id);
    if(id === 'admin') renderAdminAllData();
    if(id === 'analyst') renderAnalystCharts();
    if(id === 'observer') renderObserverReports();
  }else{
    showPopup("Access Denied", `You cannot access the ${capitalize(id)} role.`);
  }
}

/* Role access rules:
   - admin: access to all sections
   - others: only 'home' and their own section
*/
function canAccessRole(userRole, target){
  if(!userRole) return false;
  userRole = userRole.toLowerCase();
  target = target.toLowerCase();
  if(userRole === 'admin') return true;
  if(target === 'home') return true;
  return userRole === target;
}

function capitalize(s){
  if(!s) return s;
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* ------------------------------
   Login handling (Voter ID + Role)
   Voter ID format: 3 uppercase letters + 7 digits => /^[A-Z]{3}[0-9]{7}$/
------------------------------ */
function handleLogin(e){
  if(e && e.preventDefault) e.preventDefault();
  const voterIdRaw = (document.getElementById("voterId").value || '').trim();
  const voterId = voterIdRaw.toUpperCase();
  const phone = (document.getElementById("phone").value || '').trim();
  const role = (document.getElementById("roleSelect").value || '').trim().toLowerCase();

  const voterPattern = /^[A-Z]{3}[0-9]{7}$/;
  if(!voterPattern.test(voterId)){
    showPopup("Invalid Voter ID","Enter a valid Voter ID (3 uppercase letters followed by 7 digits, e.g. APZ1234567).");
    return false;
  }
  if(!/^[6-9]\d{9}$/.test(phone)){
    showPopup("Invalid Phone","Enter a valid 10-digit Indian number.");
    return false;
  }
  if(!role){
    showPopup("Missing Role","Please select your role to continue.");
    return false;
  }

  // set logged in
  setLogged(true, voterId, role);
  showPopup("Login Successful","Redirecting...");
  // show logout button
  document.getElementById('logoutBtn').style.display = 'inline-block';
  // after short delay, show home
  setTimeout(()=>{ showSection("home"); }, 900);
  return false;
}

function guestAttempt(){ showPopup("Guest Mode","Limited access only."); }

/* ------------------------------
   Issue management
   - Issues persist in localStorage key: 'ems-issues'
   - Each issue: { id, time, user, issue, status, photo? }
------------------------------ */

function loadIssuesFromStorage(){
  try{
    const raw = localStorage.getItem('ems-issues');
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
    return [];
  }catch(e){
    return [];
  }
}
function saveIssuesToStorage(arr){
  localStorage.setItem('ems-issues', JSON.stringify(arr));
}

/* render citizen issues into admin table (separate from old renderAdminIssues) */
function renderAdminCitizenIssues(){
  const tbody = document.querySelector('#adminCitizenTable tbody');
  if(!tbody) return;
  const issues = loadIssuesFromStorage();
  tbody.innerHTML = '';

  if(issues.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="color:var(--text-muted)">No citizen issues reported yet.</td>`;
    tbody.appendChild(tr);
    return;
  }

  issues.sort((a,b)=>b.id - a.id);
  issues.forEach(issue => {
    const tr = document.createElement('tr');

    const tdTime = document.createElement('td'); tdTime.textContent = issue.time || ''; tr.appendChild(tdTime);
    const tdUser = document.createElement('td'); tdUser.textContent = issue.user || ''; tr.appendChild(tdUser);
    const tdIssue = document.createElement('td'); tdIssue.textContent = issue.issue || ''; tr.appendChild(tdIssue);

    const tdPhoto = document.createElement('td');
    if(issue.photo){
      const img = document.createElement('img');
      img.src = issue.photo;
      img.className = 'issue-thumb';
      img.alt = 'photo';
      img.addEventListener('click', ()=> showImagePopup(`Photo ‚Äî ${issue.user}`, issue.photo));
      tdPhoto.appendChild(img);
    }else{
      tdPhoto.textContent = '-';
    }
    tr.appendChild(tdPhoto);

    const tdStatus = document.createElement('td');
    tdStatus.textContent = issue.status || 'Pending';
    tdStatus.className = issue.status === 'Solved' ? 'status-solved' : 'status-pending';
    tdStatus.id = `citizen-status-${issue.id}`;
    tr.appendChild(tdStatus);

    const tdAction = document.createElement('td');
    const chk = document.createElement('input'); chk.type='checkbox';
    chk.checked = (issue.status==='Solved');
    chk.disabled = (issue.status==='Solved');
    chk.addEventListener('change', ()=> {
      if(chk.checked){
        markIssueSolved(issue.id);
        const st = document.getElementById(`citizen-status-${issue.id}`);
        if(st){ st.textContent = 'Solved'; st.classList.remove('status-pending'); st.classList.add('status-solved'); st.style.color='#8BC34A'; }
        chk.disabled = true;
        showPopup('Marked Solved','Citizen issue marked solved.');
        renderAdminCitizenIssues();
        renderAnalystCharts();
      }
    });
    tdAction.appendChild(chk);
    tr.appendChild(tdAction);

    tbody.appendChild(tr);
  });
}

/* ------------------------------
   Observer storage & rendering for admin
------------------------------ */
function loadObserverReports(){
  try{
    const raw = localStorage.getItem('ems-observer-reports');
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
    return [];
  }catch(e){
    return [];
  }
}
function saveObserverReports(arr){
  localStorage.setItem('ems-observer-reports', JSON.stringify(arr));
}

function renderAdminObserverReports(){
  const tbody = document.querySelector('#adminObserverTable tbody');
  if(!tbody) return;
  const reports = loadObserverReports();
  tbody.innerHTML = '';

  if(reports.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="color:var(--text-muted)">No observer reports yet.</td>`;
    tbody.appendChild(tr);
    return;
  }

  reports.sort((a,b)=>b.id - a.id);
  reports.forEach(rep=>{
    const tr = document.createElement('tr');

    const tdTime = document.createElement('td'); tdTime.textContent = rep.time || ''; tr.appendChild(tdTime);
    const tdObs = document.createElement('td'); tdObs.textContent = rep.observer || ''; tr.appendChild(tdObs);
    const tdArea = document.createElement('td'); tdArea.textContent = rep.area || ''; tr.appendChild(tdArea);
    const tdProblem = document.createElement('td'); tdProblem.textContent = rep.problem || ''; tr.appendChild(tdProblem);

    const tdPhotos = document.createElement('td');
    if(rep.photos && rep.photos.length){
      rep.photos.forEach(p=>{
        const img = document.createElement('img');
        img.src = p; img.className = 'issue-thumb';
        img.style.width = '60px'; img.style.marginRight = '6px';
        img.addEventListener('click', ()=> showImagePopup(`Photo ‚Äî ${rep.area}`, p));
        tdPhotos.appendChild(img);
      });
    }else{
      tdPhotos.textContent = '-';
    }
    tr.appendChild(tdPhotos);

    const tdAction = document.createElement('td');
    const btnResolve = document.createElement('button');
    btnResolve.className = 'btn';
    btnResolve.textContent = rep.status === 'Resolved' ? 'Resolved' : 'Mark Resolved';
    btnResolve.disabled = rep.status === 'Resolved';
    btnResolve.addEventListener('click', ()=>{
      markObserverResolved(rep.id);
      btnResolve.textContent = 'Resolved';
      btnResolve.disabled = true;
      renderAdminObserverReports();
      renderObserverReports();
      renderAnalystCharts();
      showPopup('Observer Report','Marked resolved.');
    });
    tdAction.appendChild(btnResolve);
    tr.appendChild(tdAction);

    tbody.appendChild(tr);
  });
}

function markObserverResolved(id){
  const reports = loadObserverReports();
  const idx = reports.findIndex(r=>r.id === id);
  if(idx >= 0){
    reports[idx].status = 'Resolved';
    saveObserverReports(reports);
  }
}

/* ------------------------------
   Analyst reports storage & admin view
------------------------------ */
function loadAnalystReports(){
  try{
    const raw = localStorage.getItem('ems-analyst-reports');
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
    return [];
  }catch(e){
    return [];
  }
}
function saveAnalystReports(arr){
  localStorage.setItem('ems-analyst-reports', JSON.stringify(arr));
}

function renderAdminAnalystReports(){
  const tbody = document.querySelector('#adminAnalystTable tbody');
  if(!tbody) return;
  const reports = loadAnalystReports();
  tbody.innerHTML = '';

  if(reports.length === 0){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="4" style="color:var(--text-muted)">No analyst reports yet.</td>`;
    tbody.appendChild(tr);
    return;
  }

  reports.sort((a,b)=>b.id - a.id);
  reports.forEach(r=>{
    const tr = document.createElement('tr');
    const tdTime = document.createElement('td'); tdTime.textContent = r.time || ''; tr.appendChild(tdTime);
    const tdAnalyst = document.createElement('td'); tdAnalyst.textContent = r.analyst || ''; tr.appendChild(tdAnalyst);
    const tdNotes = document.createElement('td'); tdNotes.textContent = r.notes || ''; tr.appendChild(tdNotes);
    const tdSummary = document.createElement('td'); tdSummary.textContent = r.summary || ''; tr.appendChild(tdSummary);
    tbody.appendChild(tr);
  });
}

/* download JSON helper */
function downloadJSON(filename, data){
  try{
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${filename}.json`;
    document.body.appendChild(a); a.click();
    a.remove(); URL.revokeObjectURL(url);
  }catch(e){
    showPopup('Export Error','Could not export data.');
  }
}

/* convenience: render all admin sections */
function renderAdminAllData(){
  renderAdminCitizenIssues();
  renderAdminObserverReports();
  renderAdminAnalystReports();
}

/* ------------------------------
   File read helper
------------------------------ */
function readFileAsDataURL(file){
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = ()=> reject(new Error('File read error'));
    fr.readAsDataURL(file);
  });
}

/* ------------------------------
   Citizen submit (unchanged from before)
------------------------------ */
async function submitIssue(){
  if(!isLoggedIn()){
    showPopup("Please login","You must login to submit issues.");
    showSection("login");
    return;
  }

  const txt = (document.getElementById("issueText").value || '').trim();
  if(!txt){
    showPopup("Empty","Please describe the issue.");
    return;
  }

  // handle photo (optional)
  const fileInput = document.getElementById('issuePhoto');
  let photoDataUrl = '';
  if(fileInput && fileInput.files && fileInput.files[0]){
    const file = fileInput.files[0];
    const maxBytes = 3 * 1024 * 1024; // 3MB
    const allowedTypes = ['image/jpeg','image/png','image/webp','image/jpg'];
    if(!allowedTypes.includes(file.type)){
      showPopup('Invalid File','Please upload JPG or PNG images only.');
      return;
    }
    if(file.size > maxBytes){
      showPopup('File Too Large','Please use an image smaller than 3MB.');
      return;
    }
    try{
      photoDataUrl = await readFileAsDataURL(file);
    }catch(e){
      showPopup('Upload Error','Could not read the image file.');
      return;
    }
  }

  // prepare issue object
  const now = new Date();
  const time = now.toLocaleString();
  const user = getUser();

  const issues = loadIssuesFromStorage();
  const id = Date.now(); // unique
  const issueObj = {
    id,
    time,
    user,
    issue: txt,
    status: 'Pending',
    photo: photoDataUrl || ''
  };
  issues.push(issueObj);
  saveIssuesToStorage(issues);

  // re-render admin table
  renderAdminCitizenIssues();

  // update counters (increment active & total)
  const activeEl = document.getElementById('metricActive');
  const totalEl = document.getElementById('metricTotal');

  // try to parse numbers while preserving commas
  if(activeEl){
    const current = Number(String(activeEl.textContent || '0').replaceAll(',','')) || 0;
    activeEl.textContent = (current + 1).toLocaleString();
  }
  if(totalEl){
    const current = Number(String(totalEl.textContent || '0').replaceAll(',','')) || 0;
    totalEl.textContent = (current + 1).toLocaleString();
  }

  // clear input & show popup
  document.getElementById("issueText").value = '';
  if(fileInput) fileInput.value = '';
  const preview = document.getElementById('photoPreview');
  if(preview) preview.innerHTML = '';
  showPopup("Issue Submitted","Thank you for reporting.");
  renderAnalystCharts();
}

/* mark issue solved in storage */
function markIssueSolved(issueId){
  const issues = loadIssuesFromStorage();
  const idx = issues.findIndex(i=>i.id === issueId);
  if(idx >= 0){
    issues[idx].status = 'Solved';
    saveIssuesToStorage(issues);
  }
}

/* update metrics from stored issues (used on load & render) */
function updateMetricsFromIssues(issues){
  const totalEl = document.getElementById('metricTotal');
  const activeEl = document.getElementById('metricActive');
  try{
    const pendingCount = issues.filter(i => i.status !== 'Solved').length;
    if(activeEl){
      activeEl.textContent = String(pendingCount);
    }
    if(totalEl){
      const baseline = Number(String(totalEl.textContent || '0').replaceAll(',','')) || 0;
      const computedTotal = Math.max(baseline, baseline + issues.length);
      totalEl.textContent = computedTotal.toLocaleString();
    }
  }catch(e){}
}

/* when an admin resolves an issue, adjust the Active counter */
function refreshMetricsAfterSolve(){
  const activeEl = document.getElementById('metricActive');
  if(!activeEl) return;
  let current = Number(String(activeEl.textContent || '0').replaceAll(',','')) || 0;
  current = Math.max(0, current - 1);
  activeEl.textContent = String(current);
}

/* ------------------------------
   Photo preview handling for citizen
------------------------------ */
const issuePhotoInput = document.getElementById('issuePhoto');
if(issuePhotoInput){
  issuePhotoInput.addEventListener('change', async function(){
    const preview = document.getElementById('photoPreview');
    preview.innerHTML = '';
    if(this.files && this.files[0]){
      const file = this.files[0];
      const maxBytes = 3 * 1024 * 1024; // 3MB
      const allowedTypes = ['image/jpeg','image/png','image/webp','image/jpg'];
      if(!allowedTypes.includes(file.type)){
        showPopup('Invalid File','Please upload JPG or PNG images only.');
        this.value = '';
        return;
      }
      if(file.size > maxBytes){
        showPopup('File Too Large','Please use an image smaller than 3MB.');
        this.value = '';
        return;
      }
      try{
        const dataUrl = await readFileAsDataURL(file);
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = 'Preview';
        preview.appendChild(img);
      }catch(e){
        showPopup('Preview Error','Could not preview the image.');
      }
    }
  });
}

/* ------------------------------
   OBSERVER: Reports storage & UI (unchanged)
------------------------------ */
function renderObserverReports(){
  const container = document.getElementById('observerReportsList');
  if(!container) return;
  const reports = loadObserverReports();
  container.innerHTML = '';

  if(reports.length === 0){
    container.innerHTML = `<div style="color:var(--text-muted)">No observer reports submitted yet.</div>`;
    updateObserverStats();
    return;
  }

  // newest first
  reports.sort((a,b)=>b.id - a.id);
  reports.forEach(rep=>{
    const wrap = document.createElement('div');
    wrap.className = 'observer-report';

    const thumbs = document.createElement('div');
    thumbs.style.display = 'flex';
    thumbs.style.flexDirection = 'column';
    thumbs.style.gap = '6px';
    if(rep.photos && rep.photos.length){
      const thumbRow = document.createElement('div');
      thumbRow.style.display = 'flex';
      rep.photos.forEach((p, idx)=>{
        const img = document.createElement('img');
        img.src = p;
        img.alt = `photo-${idx+1}`;
        img.className = 'observer-thumb';
        img.addEventListener('click', ()=> showImagePopup(`Photo ‚Äî ${rep.area} (${rep.time})`, p));
        thumbRow.appendChild(img);
      });
      thumbs.appendChild(thumbRow);
    }else{
      const dash = document.createElement('div');
      dash.textContent = '-';
      dash.style.color = 'var(--text-muted)';
      thumbs.appendChild(dash);
    }

    const meta = document.createElement('div');
    const heading = document.createElement('div');
    heading.innerHTML = `<strong style="color:var(--royal-gold)">${escapeHtml(rep.area || 'Unknown area')}</strong>`;
    const timeLine = document.createElement('div');
    timeLine.className = 'observer-meta';
    timeLine.textContent = `${rep.time} ‚Ä¢ by ${rep.observer || 'Unknown'}`;
    const problem = document.createElement('div');
    problem.style.marginTop = '6px';
    problem.textContent = rep.problem || '';

    meta.appendChild(heading);
    meta.appendChild(timeLine);
    meta.appendChild(problem);

    wrap.appendChild(thumbs);
    wrap.appendChild(meta);
    container.appendChild(wrap);
  });

  updateObserverStats();
}

function updateObserverStats(){
  const reports = loadObserverReports();
  const totalEl = document.getElementById('obsTotal');
  const pendingEl = document.getElementById('obsPending');
  if(totalEl) totalEl.textContent = String(reports.length);
  if(pendingEl) pendingEl.textContent = String(reports.filter(r=>r.status !== 'Resolved').length);
}

function clearObserverForm(){
  const area = document.getElementById('obsArea');
  const prob = document.getElementById('obsProblem');
  const photos = document.getElementById('obsPhotos');
  const preview = document.getElementById('obsPhotoPreview');
  if(area) area.value = '';
  if(prob) prob.value = '';
  if(photos) photos.value = '';
  if(preview) preview.innerHTML = '';
}

/* handle photo preview for observer (multiple) */
const obsPhotosInput = document.getElementById('obsPhotos');
if(obsPhotosInput){
  obsPhotosInput.addEventListener('change', async function(){
    const preview = document.getElementById('obsPhotoPreview');
    preview.innerHTML = '';
    if(!this.files || this.files.length === 0) return;
    const files = Array.from(this.files).slice(0,3); // limit to 3
    const maxBytes = 3 * 1024 * 1024;
    const allowedTypes = ['image/jpeg','image/png','image/webp','image/jpg'];
    for(const file of files){
      if(!allowedTypes.includes(file.type)){
        showPopup('Invalid File','Please upload JPG or PNG images only.');
        this.value = '';
        preview.innerHTML = '';
        return;
      }
      if(file.size > maxBytes){
        showPopup('File Too Large','Please use images smaller than 3MB.');
        this.value = '';
        preview.innerHTML = '';
        return;
      }
      try{
        const dataUrl = await readFileAsDataURL(file);
        const img = document.createElement('img');
        img.src = dataUrl;
        img.alt = 'Preview';
        img.className = 'observer-thumb';
        img.addEventListener('click', ()=> showImagePopup('Preview', dataUrl));
        preview.appendChild(img);
      }catch(e){
        showPopup('Preview Error','Could not preview one of the images.');
      }
    }
  });
}

/* submit observer report (reads multiple images) */
async function submitObserverReport(){
  if(!isLoggedIn()){
    showPopup("Please login","You must login as an observer to submit reports.");
    showSection("login");
    return;
  }
  const area = (document.getElementById('obsArea').value || '').trim();
  const problem = (document.getElementById('obsProblem').value || '').trim();
  if(!area){
    showPopup('Missing Area','Please enter the voting area or booth.');
    return;
  }
  if(!problem){
    showPopup('Missing Problem','Please describe the problem observed.');
    return;
  }

  const files = (document.getElementById('obsPhotos').files) ? Array.from(document.getElementById('obsPhotos').files).slice(0,3) : [];
  const photos = [];
  const maxBytes = 3 * 1024 * 1024;
  const allowedTypes = ['image/jpeg','image/png','image/webp','image/jpg'];

  for(const f of files){
    if(!allowedTypes.includes(f.type)){
      showPopup('Invalid File','Please upload JPG or PNG images only.');
      return;
    }
    if(f.size > maxBytes){
      showPopup('File Too Large','Each image must be smaller than 3MB.');
      return;
    }
    try{
      const dataUrl = await readFileAsDataURL(f);
      photos.push(dataUrl);
    }catch(e){
      showPopup('Upload Error','Could not read one of the attached images.');
      return;
    }
  }

  const now = new Date();
  const time = now.toLocaleString();
  const observer = getUser();

  const reports = loadObserverReports();
  const id = Date.now();
  const report = {
    id,
    time,
    observer,
    area,
    problem,
    photos,
    status: 'Submitted'
  };
  reports.push(report);
  saveObserverReports(reports);

  // Also create a corresponding admin/citizen issue (first photo used as issue.photo)
  const issues = loadIssuesFromStorage();
  const issueId = Date.now() + 1; // ensure unique different id
  const issueObj = {
    id: issueId,
    time,
    user: `Observer:${observer}`,
    issue: `Observer Report ‚Äî ${area}: ${problem}`,
    status: 'Pending',
    photo: photos.length ? photos[0] : ''
  };
  issues.push(issueObj);
  saveIssuesToStorage(issues);

  renderAdminAllData();
  renderObserverReports();

  // update admin metrics (increment active & total)
  const activeEl = document.getElementById('metricActive');
  const totalEl = document.getElementById('metricTotal');
  if(activeEl){
    const current = Number(String(activeEl.textContent || '0').replaceAll(',','')) || 0;
    activeEl.textContent = (current + 1).toLocaleString();
  }
  if(totalEl){
    const current = Number(String(totalEl.textContent || '0').replaceAll(',','')) || 0;
    totalEl.textContent = (current + 1).toLocaleString();
  }

  clearObserverForm();
  showPopup('Report Submitted','Observer report has been saved and forwarded to admin.');
  renderAnalystCharts();
}

/* ------------------------------
   ANALYST: compute analysis and store reports
   Analyst will derive charts from citizen + observer data
------------------------------ */

/* simple keyword categories mapping used to classify issues */
const CATEGORY_KEYWORDS = {
  Security: ['security','crowd','violence','threat'],
  Machines: ['machine','election machine','evm','voter machine','voting machine','error'],
  'Booth Clash': ['clash','fight','conflict','clash'],
  Bribing: ['bribe','bribing','money','payment'],
  Technical: ['technical','network','internet','power','electric']
};

function inferCategoryFromText(text){
  if(!text) return 'Other';
  const t = text.toLowerCase();
  for(const [cat, keys] of Object.entries(CATEGORY_KEYWORDS)){
    for(const k of keys){
      if(t.includes(k)) return cat;
    }
  }
  return 'Other';
}

/* run analysis: aggregate counts and generate simple turnout-like series */
function runAnalysis(){
  if(!isLoggedIn()){
    showPopup("Please login","You must login as an analyst to run analysis.");
    showSection("login");
    return;
  }
  const notes = (document.getElementById('analysisNotes').value || '').trim();
  // aggregate data
  const issues = loadIssuesFromStorage();
  const observers = loadObserverReports();

  // category counts
  const categories = {};
  const allCategories = ['Security','Machines','Booth Clash','Bribing','Technical','Other'];
  allCategories.forEach(c=>categories[c]=0);
  issues.forEach(i=>{
    const cat = inferCategoryFromText(i.issue);
    categories[cat] = (categories[cat]||0) + 1;
  });
  observers.forEach(o=>{
    const cat = inferCategoryFromText(o.problem);
    categories[cat] = (categories[cat]||0) + 1;
  });

  // create a synthetic turnout-time series (8 time buckets) based on counts distribution
  const totalReports = issues.length + observers.length || 1;
  // distribute counts across 8 buckets proportionally to index with small randomness
  const base = Math.max(totalReports / 8, 1);
  const turnoutSeries = Array.from({length:8}, (_,i) => Math.min(100, Math.round((base * (1 + i*0.25) + Math.random()*5) * (100/Math.max(base*8,1)) + 20)));

  // prepare summary
  const summary = `Reports: ${issues.length} citizen, ${observers.length} observer. Top category: ${Object.entries(categories).sort((a,b)=>b[1]-a[1])[0][0]}`;

  // save analyst report
  const reports = loadAnalystReports();
  const id = Date.now();
  const now = new Date();
  const report = {
    id,
    time: now.toLocaleString(),
    analyst: getUser(),
    notes,
    summary,
    categories,
    turnoutSeries
  };
  reports.push(report);
  saveAnalystReports(reports);

  // show in UI
  renderAnalystReportsList();
  renderAnalystCharts();
  renderAdminAnalystReports();

  showPopup('Analysis Saved','Analyst report saved and charts updated.');
}

/* render analyst recent list */
function renderAnalystReportsList(){
  const container = document.getElementById('analystReportsList');
  if(!container) return;
  const reports = loadAnalystReports();
  container.innerHTML = '';
  if(reports.length === 0){
    container.innerHTML = `<div class="small-muted">No analyses yet.</div>`;
    return;
  }
  reports.sort((a,b)=>b.id - a.id);
  reports.slice(0,6).forEach(r=>{
    const el = document.createElement('div');
    el.style.padding = '8px 0';
    el.innerHTML = `<strong style="color:var(--royal-gold)">${r.time}</strong><div class="small-muted">by ${r.analyst}</div><div style="margin-top:6px">${escapeHtml(r.summary)}</div>`;
    container.appendChild(el);
  });
}

/* ------------------------------
   Charts rendering for analyst (based on stored data)
------------------------------ */
function computeChartsData(){
  const issues = loadIssuesFromStorage();
  const observers = loadObserverReports();

  // categories
  const catCounts = {'Security':0,'Machines':0,'Booth Clash':0,'Bribing':0,'Technical':0,'Other':0};
  issues.forEach(i=> { catCounts[inferCategoryFromText(i.issue)]++; });
  observers.forEach(o=> { catCounts[inferCategoryFromText(o.problem)]++; });

  // turnout/time series: create 8 buckets by distributing reports by timestamp hour if possible,
  // fallback to synthetic if timestamps are not parsable
  const buckets = Array(8).fill(0);
  const all = issues.concat(observers);
  if(all.length){
    all.forEach(item=>{
      // try to parse hour from item.time (locale string) -> extract hour number if possible
      let hour = null;
      try{
        const d = new Date(item.time);
        if(!isNaN(d.getTime())){
          hour = d.getHours();
        }
      }catch(e){}
      if(hour === null || isNaN(hour)){
        // random bucket
        const idx = Math.floor(Math.random()*8);
        buckets[idx]++;
      }else{
        // map hour to bucket index (6AM..8PM mapping)
        // We'll map 6,8,10,12,14,16,18,20 roughly to buckets: group hours accordingly
        const map = [6,8,10,12,14,16,18,20];
        let best = 0, bestDiff = 100;
        for(let i=0;i<map.length;i++){
          const diff = Math.abs(hour - map[i]);
          if(diff < bestDiff){ bestDiff = diff; best = i; }
        }
        buckets[best]++;
      }
    });
  }

  // convert buckets to a turnout-like percentage scale for the line chart
  const max = Math.max(...buckets,1);
  const turnoutSeries = buckets.map(v => Math.round((v / max) * 60) + 20); // 20..80 range

  return {
    categories: Object.keys(catCounts),
    categoryCounts: Object.values(catCounts),
    turnoutSeries
  };
}

function destroyChartsIfExist(){
  try{ if(lineChartObj){ lineChartObj.destroy(); lineChartObj = null; } }catch(e){}
  try{ if(barChartObj){ barChartObj.destroy(); barChartObj = null; } }catch(e){}
  try{ if(pieChartObj){ pieChartObj.destroy(); pieChartObj = null; } }catch(e){}
}

function renderAnalystCharts(){
  destroyChartsIfExist();
  const data = computeChartsData();

  // line chart
  const lineEl = document.querySelector("#lineChart");
  if(lineEl){
    lineChartObj = new ApexCharts(lineEl, {
      chart:{type:'line',height:260,toolbar:{show:false},foreColor:'#d5b27c'},
      stroke:{curve:'smooth',width:3},
      colors:['#d5b27c'],
      series:[
        {name:"Voter Turnout (%)",data: data.turnoutSeries}
      ],
      xaxis:{
        categories:["6AM","8AM","10AM","12PM","2PM","4PM","6PM","8PM"],
        labels:{style:{colors:'#d5b27c'}}
      },
      grid:{borderColor:"rgba(255,255,255,0.12)"}
    });
    lineChartObj.render();
  }

  // bar chart
  const barEl = document.querySelector("#barChart");
  if(barEl){
    barChartObj = new ApexCharts(barEl, {
      chart:{type:'bar',height:260,toolbar:{show:false},foreColor:'#d5b27c'},
      colors:['#d5b27c'],
      series:[
        {name:"Reports",data: data.categoryCounts}
      ],
      xaxis:{
        categories:data.categories,
        labels:{style:{colors:'#d5b27c'}}
      },
      grid:{borderColor:"rgba(255,255,255,0.12)"}
    });
    barChartObj.render();
  }

  // pie chart
  const pieEl = document.querySelector("#pieChart");
  if(pieEl){
    pieChartObj = new ApexCharts(pieEl, {
      chart:{type:'pie',height:320},
      series: data.categoryCounts,
      labels: data.categories,
      colors:["#d5b27c","#caa87a","#b0925f","#8a724e","#e9d8bd","#7f8c8d"],
      legend:{labels:{colors:'#f5f6f7'}}
    });
    pieChartObj.render();
  }

  renderAnalystReportsList();
}

/* ------------------------------
   Init: load stored issues and render
------------------------------ */
(function initApp(){
  lucide.createIcons();
  // initial rendering for all sections
  renderAdminAllData();
  renderAnalystCharts();
  renderObserverReports();
  const t = localStorage.getItem("ems-theme") || "dark";
  if(!document.documentElement.classList.contains(t)) document.documentElement.classList.add(t);

  // show logout button if logged in
  if(isLoggedIn()){
    document.getElementById('logoutBtn').style.display = 'inline-block';
    showSection('home');
  }else{
    showSection('login');
  }
})();

/* ------------------------------
   Theme Toggle
------------------------------ */
function toggleTheme(){
  const r=document.documentElement;
  if(r.classList.contains("dark")){
    r.classList.remove("dark");
    localStorage.setItem("ems-theme","light");
  }else{
    r.classList.add("dark");
    localStorage.setItem("ems-theme","dark");
  }
  lucide.createIcons();
}

/* ------------------------------
   LIVE DATA REFRESH - OBSERVER DASHBOARD
   (unchanged, kept for convenience)
------------------------------ */
function refreshLiveData(){
  const metrics = {
    reports: ['12,485', '12,642', '12,758', '12,891'],
    booths: ['4,892', '4,921', '4,956', '4,987'],
    alerts: ['47', '52', '48', '51'],
    turnout: ['68%', '71%', '74%', '77%']
  };

  const alertMessages = [
    {icon:'‚óè',color:'var(--royal-gold)',msg:'<strong style="color:var(--royal-gold-soft)">Booth #1245:</strong> Verified setup completed'},
    {icon:'‚óè',color:'#ff9800',msg:'<strong style="color:#ffb74d">Region East:</strong> 92% polling stations active'},
    {icon:'‚óè',color:'#2196f3',msg:'<strong style="color:#64b5f6">Observer Report:</strong> No irregularities at polling centre #456'},
    {icon:'‚óè',color:'var(--royal-gold)',msg:'<strong style="color:var(--royal-gold-soft)">Booth #2034:</strong> Machine calibrated & ready'},
    {icon:'‚óè',color:'#4caf50',msg:'<strong style="color:#81c784">Region West:</strong> All booths operational'},
    {icon:'‚óè',color:'#ff5722',msg:'<strong style="color:#ffb74d">Alert:</strong> High turnout in Region North'},
    {icon:'‚óè',color:'#9c27b0',msg:'<strong style="color:#ce93d8">Verification:</strong> Documents checked at booth #789'}
  ];

  // Update metrics with random values
  const getRandomIndex = (arr)=>Math.floor(Math.random()*arr.length);
  const elReports = document.getElementById('reports');
  const elBooths = document.getElementById('booths');
  const elAlerts = document.getElementById('alerts');
  const elTurnout = document.getElementById('turnout');
  if(elReports) elReports.textContent = metrics.reports[getRandomIndex(metrics.reports)];
  if(elBooths) elBooths.textContent = metrics.booths[getRandomIndex(metrics.booths)];
  if(elAlerts) elAlerts.textContent = metrics.alerts[getRandomIndex(metrics.alerts)];
  if(elTurnout) elTurnout.textContent = metrics.turnout[getRandomIndex(metrics.turnout)];

  // Update alerts feed
  const alertFeed = document.getElementById('liveAlerts');
  if(alertFeed){
    const randomAlerts = alertMessages.sort(()=>Math.random()-0.5).slice(0,5);
    alertFeed.innerHTML = randomAlerts.map(alert=>`
      <div style="padding:12px;border-bottom:1px solid rgba(255,255,255,0.08);color:#ddd;display:flex;gap:10px">
        <span style="color:${alert.color}">${alert.icon}</span>
        <span>${alert.msg}</span>
      </div>
    `).join('');
  }

  showPopup('Data Refreshed','Live metrics updated');
}
</script>

</body>
</html>
